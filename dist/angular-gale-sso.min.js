/*------------------------------------------------------
 Company:           Gale Framework Ltda.
 Author:            David Gaete <dmunozgaete@gmail.com> (https://github.com/dmunozgaete)
 
 Description:       Angular Gale Single Sign On
 Github:            https://github.com/dmunozgaete/angular-gale-sso

 Versi√≥n:           1.0.0-rc.1
 Build Date:        2016-10-03 17:45:55
------------------------------------------------------*/


angular.module("gale-sso.templates",[]).run(["$templateCache",function($templateCache){"use strict";$templateCache.put("gale-sso/gale-sso.tpl.html","<flex-loading ng-if=model.isLoading></flex-loading><iframe frameborder=0 border=0 cellspacing=0 ng-show=!model.isLoading></iframe>")}]),angular.manifiest("gale-sso",["gale-sso.templates","gale-sso.components","gale-sso.services"],["gale"]),angular.module("gale-sso.components").directive("galeSso",["$log","$q","$cordovaSingleSignOn",function($log,$q,$cordovaSingleSignOn){return{restrict:"E",scope:{onLoginSuccess:"&",onLoginError:"&"},templateUrl:"gale-sso/gale-sso.tpl.html",controller:["$scope","$element","$q","$timeout",function($scope,$element,$q,$timeout){var vm=$scope.model={isLoading:!0},oauth2=$cordovaSingleSignOn.$$buildAuthorization(["profile","delivery"]),iframe=$element.find("iframe");iframe.attr("src",oauth2.oauth2Url),iframe.bind("load",function(){var delay=$timeout(function(){$timeout.cancel(delay),vm.isLoading=!1;var finaly=!1,windowElm=angular.element(window),fn=function(e){finaly||e.origin!==oauth2.hostToMatch||0!==e.data.indexOf(oauth2.callbackUrl)||(windowElm.unbind("message",fn),oauth2.parser(e.data).then(function(data){var handler=$scope.onLoginSuccess();handler&&handler(data)},function(){var handler=$scope.onLoginError();handler&&handler(data)}),finaly=!0)};windowElm.bind("message",fn)},10)}),$scope.$on("$destroy",function(){})}]}}]),angular.module("gale-sso.services").provider("$cordovaSingleSignOn",function(){var $this=this,_appId=null,_ssoBaseURL=null;this.setAppId=function(value){return _appId=value,$this},this.setApiUrl=function(value){return value&&!value.endsWith("/")&&(value+="/"),_ssoBaseURL=value,$this},this.$get=["$q","$Api",function($q,$Api){var self=this,_authResponse=null;self.getAppId=function(){if(!_appId)throw Error("APP_ID_NOT_SET");return _appId},self.getApiUrl=function(){if(!_ssoBaseURL)throw Error("SSO_BASEURL_NOT_SET");return _ssoBaseURL},self.getAccessToken=function(){if(!_authResponse)throw Error("MUST_CALL_LOGIN_BEFORE_GET_ACCESSTOKEN");return _authResponse.access_token};var parseFragment=function(uri){var parsed=$q.defer(),qs=uri.substring(uri.indexOf("#")+1).split("&"),build=function(tokens){var j={};for(var q in qs){var text=qs[q];for(var prop in tokens){var name=tokens[prop];if(0!==text.indexOf(name));else{var value=text.replace(name+"=","");j[tokens[prop]]="expires_in"===name?parseInt(value):value}}}return j};return setTimeout(function(){var isSuccess=function(){var ok=!1;return angular.forEach(qs,function(q){return 0===q.indexOf("access_token")?(ok=!0,!1):void 0}),ok}();if(isSuccess){var j1=build(["access_token","expires_in","token_type"]);_authResponse=j1,parsed.resolve({authResponse:j1,status:"connected"})}else{var j2=build(["error"]);parsed.reject({status:"not_connected",error:j2})}},10),parsed.promise};return self.$$buildAuthorization=function(permissions,settings){var _settings=settings||{},scopes=permissions.join(","),response_type="token",redirect_uri="oauth2/v2/connect/oauth2_callback.html?origin=",state=null,prompt=_settings.prompt||"consent",api_url=self.getApiUrl(),host_url=function(){var pathArray=api_url.split("/"),protocol=pathArray[0],host=pathArray[2],url=protocol+"//"+host;return url}(),callback_url=api_url+redirect_uri+location.origin,oauth2_url=[self.getApiUrl(),"oauth2/v2/auth","?response_type=",response_type,"&client_id=",self.getAppId(),"&redirect_uri=",callback_url,"&scope=",scopes,"&prompt=",prompt,"&state=",state].join("");return{oauth2Url:oauth2_url,hostToMatch:host_url,callbackUrl:callback_url,parser:parseFragment}},self.login=function(permissions,settings){var defer=$q.defer(),mode="object"==typeof ionic?"ionic":"browser";"ionic"===mode&&(ionic.Platform.isWebView()||(mode="browser"));var oauth2=self.$$buildAuthorization(permissions,settings);switch(mode){case"ionic":var inApp_features=["toolbar=no","location=no","clearsessioncache=no","clearcache=no"].join(","),browser=cordova.InAppBrowser.open(oauth2.oauth2Url,"_blank",inApp_features);browser.addEventListener("loadstop",function(e){0===e.url.indexOf(oauth2.callbackUrl)&&parseFragment(e.url).then(function(data){browser.close(),defer.resolve(data)},function(e){browser.close(),defer.reject(e)})});break;case"browser":var height=600,width=650,left=screen.width/2-width/2,top=screen.height/2-height/2,browser_features=["toolbar=0","location=0","directories=0","status=0","menubar=0","scrollbars=0","resizable=0","copyhistory=0","width="+width,"height="+height,"top="+top,"left="+left].join(","),finaly=!1,windowElm=angular.element(window),fn=(window.open(oauth2.oauth2Url,"oauth2_sso",browser_features),function(e){finaly||e.origin!==oauth2.hostToMatch||0!==e.data.indexOf(oauth2.callbackUrl)||(windowElm.unbind("message",fn),parseFragment(e.data).then(function(data){defer.resolve(data)},function(e){defer.reject(e)}),finaly=!0)});windowElm.bind("message",fn)}return defer.promise},self.api=function(query){var defer=$q.defer(),accessToken=self.getAccessToken();return $Api.read("{sso_url}Accounts/{query}",{sso_url:self.getApiUrl(),query:query},{Authorization:"Bearer "+accessToken}).success(function(data){defer.resolve(data)}).error(function(err){defer.reject(err)}),defer.promise},self}]});
//# sourceMappingURL=angular-gale-sso.min.js.map